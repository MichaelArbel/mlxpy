<!doctype html>
<html class="no-js" lang="en" data-content_root="./">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="genindex.html" /><link rel="search" title="Search" href="search.html" /><link rel="next" title="2- Logging" href="easy_logging.html" /><link rel="prev" title="Introduction" href="tutorial_introduction.html" />

    <!-- Generated with Sphinx 7.2.6 and Furo 2024.01.29 -->
        <title>1- Launching - MLXP 1.0</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo.css?v=135e06be" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo-extensions.css?v=36a5483c" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="index.html"><div class="brand">MLXP 1.0</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="index.html">
  
  
  <span class="sidebar-brand-text">MLXP 1.0</span>
  
</a><form class="sidebar-search-container" method="get" action="search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div>
<div class="sidebar-tree">
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="index.html">Versions</a><input class="toctree-checkbox" id="toctree-checkbox-v" name="toctree-checkbox-v" role="switch" type="checkbox"/><label for="toctree-checkbox-v"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label>
  <ul>
  <!-- extract version from branch name  of the form relase/0.2.x -->
    <li class="toctree-l2"><a class="reference internal" href="easy_launching.html">0.2</a></li>
  <!-- extract version from branch name  of the form relase/0.2.x -->
    <li class="toctree-l2"><a class="reference internal" href="../1.0.x/easy_launching.html">1.0</a></li>
  </ul>
</li>
</ul>
</div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Content:</span></p>
<ul class="current">
<li class="toctree-l1 current has-children"><a class="reference internal" href="guide.html">Guide</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Guide</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="installing.html">Installing MLXP</a></li>
<li class="toctree-l2"><a class="reference internal" href="getting_started.html">Quick start guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuring_mlxp.html">Configuring MLXP</a></li>
<li class="toctree-l2 current has-children"><a class="reference internal" href="tutorial.html">Tutorial</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Tutorial</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="tutorial_introduction.html">Introduction</a></li>
<li class="toctree-l3 current current-page"><a class="current reference internal" href="#">1- Launching</a></li>
<li class="toctree-l3"><a class="reference internal" href="easy_logging.html">2- Logging</a></li>
<li class="toctree-l3"><a class="reference internal" href="easy_versioning.html">3- Versioning</a></li>
<li class="toctree-l3"><a class="reference internal" href="easy_reading.html">3- Reading</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial_conclusion.html">Conclusion</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="mlxp.html">MLXP package</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of MLXP package</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="mlxp.launching.html">Launcher</a></li>
<li class="toctree-l2"><a class="reference internal" href="mlxp.logging.html">Logger</a></li>
<li class="toctree-l2"><a class="reference internal" href="mlxp.reading.html">Reader</a></li>
<li class="toctree-l2"><a class="reference internal" href="mlxp.scheduling.html">Scheduler</a></li>
<li class="toctree-l2"><a class="reference internal" href="mlxp.version_managment.html">Version manager</a></li>
<li class="toctree-l2"><a class="reference internal" href="mlxp.data_structures.html">Data structures</a></li>
</ul>
</li>
</ul>

</div>
</div>
      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="launching">
<h1>1- Launching<a class="headerlink" href="#launching" title="Link to this heading">#</a></h1>
<p>We will see how to modify the file <code class="samp docutils literal notranslate"><span class="pre">main.py</span></code> to use MLXP using the decorator <code class="samp docutils literal notranslate"><span class="pre">mlxp.launch</span></code>.
But first, let’s introduce the <code class="samp docutils literal notranslate"><span class="pre">mlxp.Context</span></code> object produced by the decorator <code class="samp docutils literal notranslate"><span class="pre">mlxp.launch</span></code> that allows using MLXP’s logging and configuring functionalities.</p>
<section id="the-context-object">
<h2>The Context object<a class="headerlink" href="#the-context-object" title="Link to this heading">#</a></h2>
<p>MLXP uses an object <code class="samp docutils literal notranslate"><span class="pre">ctx</span></code> of the class <code class="samp docutils literal notranslate"><span class="pre">mlxp.Context</span></code> that is created on the fly during the execution of the program to store information about the run.
More precisely, it contains 4 fields:</p>
<ul class="simple">
<li><p><code class="samp docutils literal notranslate"><span class="pre">ctx.config</span></code>: Stores project-specific options provided by the user. These options are loaded from a yaml file called <code class="samp docutils literal notranslate"><span class="pre">config.yaml</span></code>  located in a directory <code class="samp docutils literal notranslate"><span class="pre">config_path</span></code> provided as input to the decorator <code class="samp docutils literal notranslate"><span class="pre">mlxp.launch</span></code>.</p></li>
<li><p><code class="samp docutils literal notranslate"><span class="pre">ctx.mlxp</span></code>: Stores MLXP’s default settings for the project. Its content is loaded from a yaml file <code class="samp docutils literal notranslate"><span class="pre">mlxp.yaml</span></code>  located in the same directory <code class="samp docutils literal notranslate"><span class="pre">config_path</span></code>.</p></li>
<li><p><code class="samp docutils literal notranslate"><span class="pre">ctx.info</span></code>: Contains information about the current run: ex. status, start time, hostname, etc.</p></li>
<li><p><code class="samp docutils literal notranslate"><span class="pre">ctx.logger</span></code>: A logger object that can be used in the code for logging variables (metrics, checkpoints, artifacts). When logging is enabled, these variables are all stored in a uniquely defined directory.</p></li>
</ul>
</section>
<section id="general-setup">
<h2>General setup<a class="headerlink" href="#general-setup" title="Link to this heading">#</a></h2>
<section id="defining-a-default-config-file">
<h3>Defining a default config file<a class="headerlink" href="#defining-a-default-config-file" title="Link to this heading">#</a></h3>
<p>The first step is to provide all default options that will be used by the code in a separate Yaml file named <code class="samp docutils literal notranslate"><span class="pre">config.yaml</span></code> and contained in the <code class="samp docutils literal notranslate"><span class="pre">./configs</span></code> directory.</p>
<div class="literal-block-wrapper docutils container" id="id4">
<div class="code-block-caption"><span class="caption-text">./configs/config.yaml</span><a class="headerlink" href="#id4" title="Link to this code">#</a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">seed</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
<span class="nt">num_epoch</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
<span class="nt">model</span><span class="p">:</span>
<span class="w"> </span><span class="nt">num_units</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100</span>
<span class="nt">data</span><span class="p">:</span>
<span class="w"> </span><span class="nt">d_int</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
<span class="w"> </span><span class="nt">device</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;cpu&#39;</span>
<span class="nt">optimizer</span><span class="p">:</span>
<span class="w"> </span><span class="nt">lr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.</span>
</pre></div>
</div>
</div>
<p>Here, we stored all options that were provided as input to the function <code class="samp docutils literal notranslate"><span class="pre">train</span></code> in the <code class="samp docutils literal notranslate"><span class="pre">main.py</span></code> file (such as the learning rate <code class="samp docutils literal notranslate"><span class="pre">lr</span></code>, number of epochs <code class="samp docutils literal notranslate"><span class="pre">num_epochs</span></code>, etc) into a structured Yaml file. The user has the freedom to define their own structure: for instance, here we chose to group the input dimension <code class="samp docutils literal notranslate"><span class="pre">d_int</span></code> and <code class="samp docutils literal notranslate"><span class="pre">device</span></code> into the same <code class="samp docutils literal notranslate"><span class="pre">data</span></code> group, but other (probably better choices) are possible.
MLXP will load this file by default, just like in <a class="reference external" href="https://hydra.cc/">hydra</a> and provide these options as a hierachical dictionary to be used in the code (more about this later!).</p>
</section>
<section id="adapting-code-for-using-mlxp">
<h3>Adapting code for using MLXP<a class="headerlink" href="#adapting-code-for-using-mlxp" title="Link to this heading">#</a></h3>
<p>To use MLXP, we only need to slightly change the <code class="samp docutils literal notranslate"><span class="pre">main.py</span></code> file.
The first step is to import MLXP and use the decorator <code class="samp docutils literal notranslate"><span class="pre">mlxp.launch</span></code> above the function <code class="samp docutils literal notranslate"><span class="pre">train</span></code>.
We also need to change the signature of the function <code class="samp docutils literal notranslate"><span class="pre">train</span></code> so that it can accept an object <code class="samp docutils literal notranslate"><span class="pre">ctx</span></code> of type <code class="samp docutils literal notranslate"><span class="pre">mlxp.Context</span></code>  as an argument instead of the variables.
Note, however, that <code class="samp docutils literal notranslate"><span class="pre">train</span></code> is called later without explicitly passing any argument. The remaining modifications are:</p>
<ul class="simple">
<li><p>Using the option values stored in <code class="samp docutils literal notranslate"><span class="pre">ctx.config</span></code> as a replacement to the variables provided in the older version of the code (See: <a class="reference internal" href="tutorial_introduction.html#old-main-file"><span class="std std-ref">the old ‘main.py’ file</span></a>).</p></li>
<li><p>Using the logger <code class="samp docutils literal notranslate"><span class="pre">ctx.logger</span></code> to store the results of the run (instead of printing them) and saving checkpoints.</p></li>
</ul>
<p>Here is how the code would look like:</p>
<div class="literal-block-wrapper docutils container" id="id5">
<div class="code-block-caption"><span class="caption-text">main.py</span><a class="headerlink" href="#id5" title="Link to this code">#</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">core</span> <span class="kn">import</span> <span class="n">DataLoader</span><span class="p">,</span> <span class="n">OneHiddenLayer</span>

<span class="kn">import</span> <span class="nn">mlxp</span>

<span class="nd">@mlxp</span><span class="o">.</span><span class="n">launch</span><span class="p">(</span><span class="n">config_path</span><span class="o">=</span><span class="s1">&#39;./configs&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">mlxp</span><span class="o">.</span><span class="n">Context</span><span class="p">)</span><span class="o">-&gt;</span><span class="kc">None</span><span class="p">:</span>

    <span class="n">cfg</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">config</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">logger</span>

    <span class="n">start_epoch</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Building model, optimizer and data loader.</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">OneHiddenLayer</span><span class="p">(</span><span class="n">d_int</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">d_int</span><span class="p">,</span>
                            <span class="n">n_units</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">num_units</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span>
                                <span class="n">lr</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">lr</span><span class="p">)</span>
    <span class="n">dataloader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">d_int</span><span class="p">,</span>
                            <span class="n">cfg</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

    <span class="c1"># Training</span>
    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_epoch</span><span class="p">,</span><span class="n">cfg</span><span class="o">.</span><span class="n">num_epoch</span><span class="p">):</span>

        <span class="n">train_err</span> <span class="o">=</span> <span class="n">train_epoch</span><span class="p">(</span><span class="n">dataloader</span><span class="p">,</span>
                                <span class="n">model</span><span class="p">,</span>
                                <span class="n">optimizer</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">log_metrics</span><span class="p">({</span><span class="s1">&#39;loss&#39;</span><span class="p">:</span> <span class="n">train_err</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
                            <span class="s1">&#39;epoch&#39;</span><span class="p">:</span> <span class="n">epoch</span><span class="p">},</span> <span class="n">log_name</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">log_checkpoint</span><span class="p">({</span><span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span>
                               <span class="s1">&#39;epoch&#39;</span><span class="p">:</span><span class="n">epoch</span><span class="p">},</span> <span class="n">log_name</span><span class="o">=</span><span class="s1">&#39;last_ckpt&#39;</span> <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Completed training with learing rate: </span><span class="si">{</span><span class="n">cfg</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">lr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">train</span><span class="p">()</span>
</pre></div>
</div>
</div>
</section>
<section id="seeding-code-using-mlxp">
<h3>Seeding code using MLXP<a class="headerlink" href="#seeding-code-using-mlxp" title="Link to this heading">#</a></h3>
<p>In our example, the initialization of the model uses random initial parameters which might change from one run to another. To avoid this, the user can provide a function <code class="samp docutils literal notranslate"><span class="pre">seeding_function</span></code> to the <code class="samp docutils literal notranslate"><span class="pre">mlxp.launch</span></code> decorator to set the global seeds of whatever random number generator is used.</p>
<div class="literal-block-wrapper docutils container" id="id6">
<div class="code-block-caption"><span class="caption-text">main.py</span><a class="headerlink" href="#id6" title="Link to this code">#</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mlxp</span>
<span class="kn">from</span> <span class="nn">core</span> <span class="kn">import</span> <span class="n">DataLoader</span><span class="p">,</span> <span class="n">Network</span><span class="p">,</span> <span class="n">Optimizer</span><span class="p">,</span> <span class="n">Loss</span>

<span class="k">def</span> <span class="nf">seeding_function</span><span class="p">(</span><span class="n">seed</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">torch</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

<span class="nd">@mlxp</span><span class="o">.</span><span class="n">launch</span><span class="p">(</span><span class="n">config_path</span><span class="o">=</span><span class="s1">&#39;./configs&#39;</span><span class="p">,</span>
            <span class="n">seeding_function</span><span class="o">=</span><span class="n">seeding_function</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">mlxp</span><span class="o">.</span><span class="n">Context</span><span class="p">)</span><span class="o">-&gt;</span><span class="kc">None</span><span class="p">:</span>

    <span class="n">cfg</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">config</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">logger</span>

    <span class="o">...</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">train</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>The function <code class="samp docutils literal notranslate"><span class="pre">seeding_function</span></code> will be called by MLXP before executing the function <code class="samp docutils literal notranslate"><span class="pre">train</span></code>. The parameter seed is read from the user-defined option: <code class="samp docutils literal notranslate"><span class="pre">ctx.config.seed</span></code>. If the field seed is not provided by the user and a seeding function is passed, then the code throws an error.
Note that the field <code class="samp docutils literal notranslate"><span class="pre">seed</span></code> passed to the <code class="samp docutils literal notranslate"><span class="pre">seeding_function</span></code> can be an integer or a dictionary or any object that can be stored in a yaml file.
Of course, it is also possible to perform seeding inside the function <code class="samp docutils literal notranslate"><span class="pre">train</span></code>, but <code class="samp docutils literal notranslate"><span class="pre">seeding_function</span></code>  allows you to do it systematically.</p>
</section>
</section>
<section id="launching-locally-using-mlxp">
<span id="launching-multiruns"></span><h2>Launching locally using MLXP<a class="headerlink" href="#launching-locally-using-mlxp" title="Link to this heading">#</a></h2>
<p>During execution, the default configurations will be read from the file <code class="samp docutils literal notranslate"><span class="pre">config.yaml</span></code> located in the directory <code class="samp docutils literal notranslate"><span class="pre">./configs</span></code> and passed to the object <code class="samp docutils literal notranslate"><span class="pre">ctx.config</span></code>. The code will be executed using these option:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>python<span class="w"> </span>main.py
<span class="go">Completed training with learning rate: 10.0</span>
</pre></div>
</div>
<p>Just like with <a class="reference external" href="https://hydra.cc/">hydra</a>, we can run the code again with different options by overriding the default ones from the command line. For instance, we can use different learning rates and even select multiple values for it (say: <code class="samp docutils literal notranslate"><span class="pre">1e-2</span></code> and <code class="samp docutils literal notranslate"><span class="pre">1e-1</span></code>). we can do this from the command line by providing multiple values <code class="samp docutils literal notranslate"><span class="pre">(0.01,0.1)</span></code> to the option <code class="samp docutils literal notranslate"><span class="pre">optimizer.lr</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>python<span class="w"> </span>main.py<span class="w"> </span>optimizer.lr<span class="o">=</span><span class="m">0</span>.01,0.1
<span class="go">Completed training with learning rate: 0.01</span>
<span class="go">Completed training with learning rate: 0.1</span>
</pre></div>
</div>
<p>In the above instruction, we added an option <code class="samp docutils literal notranslate"><span class="pre">optimizer.lr=0.01,0.1</span></code> which execute the code twice: once using a learning rate of <code class="samp docutils literal notranslate"><span class="pre">0.01</span></code> and a second time using <code class="samp docutils literal notranslate"><span class="pre">0.1</span></code> .</p>
</section>
<section id="launching-jobs-to-a-scheduler">
<h2>Launching jobs to a scheduler<a class="headerlink" href="#launching-jobs-to-a-scheduler" title="Link to this heading">#</a></h2>
<p>If you have access to an HPC cluster, then you probably use a job scheduler for submitting jobs.
MLXP allows you to combine the ‘multirun’ capabilities of <a class="reference external" href="https://hydra.cc/">hydra</a> with job scheduling to easily submit multiple experiments to a cluster.
Currently, MLXP supports the following job schedulers:
<a class="reference external" href="https://slurm.schedmd.com/documentation.html">SLURM</a>,  <a class="reference external" href="https://oar.imag.fr/">OAR</a>, <a class="reference external" href="https://hpc-wiki.info/hpc/Torque">TORQUE</a>, <a class="reference external" href="https://gridscheduler.sourceforge.net/">SGE</a>, <a class="reference external" href="https://docs.oracle.com/cd/E58073_01/index.htm">MWM</a> and
<a class="reference external" href="https://www.ibm.com/docs/en/spectrum-lsf/10.1.0">LSF</a>.</p>
<section id="submitting-jobs-to-a-job-scheduler">
<span id="mlxpsub"></span><h3>Submitting jobs to a job scheduler<a class="headerlink" href="#submitting-jobs-to-a-job-scheduler" title="Link to this heading">#</a></h3>
<p>Let’s say, you’d like to submit multiple jobs into a job scheduler. You can do this easily using the
mlxpsub command!</p>
<p>The first step is to create a script ex.: <code class="samp docutils literal notranslate"><span class="pre">script.sh</span></code> in your working directory (here under <code class="samp docutils literal notranslate"><span class="pre">my_project/</span></code>).
In this script, you can define the resources allocated to your jobs, using the syntax of your job scheduler, as well as the python command for exectuting your main python script. You can then pass different option values to your python script <code class="samp docutils literal notranslate"><span class="pre">main.py</span></code> as discussed earlier in
<a class="reference internal" href="#launching-multiruns"><span class="std std-ref">the launching tutorial</span></a>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span>!/bin/bash

<span class="gp">#</span>OAR<span class="w"> </span>-l<span class="w"> </span><span class="nv">core</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">walltime</span><span class="o">=</span><span class="m">6</span>:00:00
<span class="gp">#</span>OAR<span class="w"> </span>-t<span class="w"> </span>besteffort
<span class="gp">#</span>OAR<span class="w"> </span>-t<span class="w"> </span>idempotent

<span class="go">python main.py  optimizer.lr=10.,1. seed=1,2</span>
<span class="go">python main.py  model.num_units=100,200 seed=1,2</span>
</pre></div>
</div>
<p>The above script is meant to create and exectute 8 jobs in total that will be submitted to an OAR job scheduler. The first 4 jobs correspond to the first python command using all possible combinations of option values for <code class="samp docutils literal notranslate"><span class="pre">optimizer.lr</span></code> and <code class="samp docutils literal notranslate"><span class="pre">seed</span></code>: <code class="samp docutils literal notranslate"><span class="pre">(10.,1)</span></code> , <code class="samp docutils literal notranslate"><span class="pre">(10.,2)</span></code>, <code class="samp docutils literal notranslate"><span class="pre">(1.,1)</span></code>, <code class="samp docutils literal notranslate"><span class="pre">(1.,2)</span></code>. The 4 next jobs are for the second command wich varies the options <code class="samp docutils literal notranslate"><span class="pre">model.num_units</span></code> and <code class="samp docutils literal notranslate"><span class="pre">seed</span></code>.</p>
<p>You only need to run the following command in the terminal:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">mlxpsub script.sh</span>
</pre></div>
</div>
</section>
<section id="what-happens-under-the-woods">
<h3>What happens under the woods?<a class="headerlink" href="#what-happens-under-the-woods" title="Link to this heading">#</a></h3>
<p>Here is what happens:</p>
<ol class="arabic simple">
<li><p>mlxpsub command parses the script to extract the scheduler’s instructions and figures out what scheduler is used, then provides those information as a context prior to executing the script.</p></li>
<li><p><a class="reference external" href="https://hydra.cc/">hydra</a> performs a cross-product of the options provided and creates as many jobs are needed.</p></li>
<li><p>The MLXP creates a separate directory for each one of these jobs. Each directory is assigned a unique log_id and contains a script to be submitted.</p></li>
<li><p>All generated scripts are submitted to the job scheduler.</p></li>
</ol>
</section>
<section id="what-you-should-expect">
<h3>What you should expect?<a class="headerlink" href="#what-you-should-expect" title="Link to this heading">#</a></h3>
<p>MLXP creates a script for each job corresponding to an option setting. Each script is located in a directory of the form
<code class="samp docutils literal notranslate"><span class="pre">parent_log/log_id</span></code>, where <code class="samp docutils literal notranslate"><span class="pre">log_id</span></code> is automatically assigned by MLXP for each job. Here is an example of the first created script in <code class="samp docutils literal notranslate"><span class="pre">logs/1/script.sh</span></code> where the user sets <code class="samp docutils literal notranslate"><span class="pre">parent_log</span></code> to <code class="samp docutils literal notranslate"><span class="pre">logs</span></code>.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span>!/bin/bash
<span class="gp">#</span>OAR<span class="w"> </span>-n<span class="w"> </span>logs/1
<span class="gp">#</span>OAR<span class="w"> </span>-E<span class="w"> </span>/root/logs/1/log.stderr
<span class="gp">#</span>OAR<span class="w"> </span>-O<span class="w"> </span>/root/logs/1/log.stdout
<span class="gp">#</span>OAR<span class="w"> </span>-l<span class="w"> </span><span class="nv">core</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">walltime</span><span class="o">=</span><span class="m">6</span>:00:00
<span class="gp">#</span>OAR<span class="w"> </span>-t<span class="w"> </span>besteffort
<span class="gp">#</span>OAR<span class="w"> </span>-t<span class="w"> </span>idempotent

<span class="go">cd /root/workdir/</span>
<span class="go">python main.py  optimizer.lr=10. seed=1</span>
</pre></div>
</div>
<p>As you can see, MLXP automatically assigns values for the job’s name, <code class="samp docutils literal notranslate"><span class="pre">stdout</span></code>  and <code class="samp docutils literal notranslate"><span class="pre">stderr</span></code> file paths,
so there is no need to specify those in the original script <code class="samp docutils literal notranslate"><span class="pre">script.sh</span></code>.
These scripts contain the same scheduler’s options
as in <code class="samp docutils literal notranslate"><span class="pre">script.sh</span></code> in addition to a single python command specific to the option setting: <code class="samp docutils literal notranslate"><span class="pre">optimizer.lr=10.</span> <span class="pre">seed=1</span></code>.
Additionally, MLXP pre-processes the python command to extract the working directory and sets it explicitly in the newly created script before the python command.</p>
<p>Once, the job finishes execution, we can double-check that everything went well by inspecting the directory <code class="samp docutils literal notranslate"><span class="pre">logs/1/</span></code> which should contain the usual logs and two additional files <code class="samp docutils literal notranslate"><span class="pre">log.stdout</span></code>  and <code class="samp docutils literal notranslate"><span class="pre">log.stderr</span></code>:</p>
<div class="literal-block-wrapper docutils container" id="id7">
<div class="code-block-caption"><span class="caption-text">./logs/</span><a class="headerlink" href="#id7" title="Link to this code">#</a></div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>logs/
├── 1/
│   ├── metadata/
│   │   ├── config.yaml
│   │   ├── info.yaml
│   │   └── mlxp.yaml
│   ├── metrics/
│   │   ├── train.json
│   │   └── .keys/
│   │        └── metrics.yaml
│   ├── artifacts/
│   │   └── Checkpoint/
│   │       └── last_ckpt.pkl
│   ├── log.stderr
│   ├── log.stdout
│   └── script.sh
│
├──...
</pre></div>
</div>
</div>
</section>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="easy_logging.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">2- Logging</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="tutorial_introduction.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Introduction</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; Copyright (C) 2023 Michael Arbel
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">1- Launching</a><ul>
<li><a class="reference internal" href="#the-context-object">The Context object</a></li>
<li><a class="reference internal" href="#general-setup">General setup</a><ul>
<li><a class="reference internal" href="#defining-a-default-config-file">Defining a default config file</a></li>
<li><a class="reference internal" href="#adapting-code-for-using-mlxp">Adapting code for using MLXP</a></li>
<li><a class="reference internal" href="#seeding-code-using-mlxp">Seeding code using MLXP</a></li>
</ul>
</li>
<li><a class="reference internal" href="#launching-locally-using-mlxp">Launching locally using MLXP</a></li>
<li><a class="reference internal" href="#launching-jobs-to-a-scheduler">Launching jobs to a scheduler</a><ul>
<li><a class="reference internal" href="#submitting-jobs-to-a-job-scheduler">Submitting jobs to a job scheduler</a></li>
<li><a class="reference internal" href="#what-happens-under-the-woods">What happens under the woods?</a></li>
<li><a class="reference internal" href="#what-you-should-expect">What you should expect?</a></li>
</ul>
</li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="_static/documentation_options.js?v=10f1778b"></script>
    <script src="_static/doctools.js?v=888ff710"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/scripts/furo.js?v=32e29ea5"></script>
    </body>
</html>